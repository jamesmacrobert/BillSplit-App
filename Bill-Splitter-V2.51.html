<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bill Buddy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cutive+Mono&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Unica+One&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Londrina+Solid&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f5f4f2;
        }
        .font-receipt {
             font-family: 'Cutive Mono', monospace;
        }
        .font-comfortaa {
            font-family: 'Comfortaa', sans-serif;
        }
        /* --- Custom Theme Colors --- */
        .font-title {
            font-family: 'Londrina Solid', sans-serif;
            color: #ff7754;
            cursor: pointer;
        }
        .text-theme {
            color: #ff7754;
        }
        .border-theme {
            border-color: #ff7754;
        }
        .bg-theme {
            background-color: #ff7754;
        }
        .hover\:bg-theme-dark:hover {
            background-color: #e66a46; /* Darker shade for hover */
        }
         .hover\:bg-theme-light:hover {
            background-color: #fff1ec; /* Lighter shade for hover */
        }
        .focus\:ring-theme:focus {
            --tw-ring-color: #ff7754;
        }

        .btn-secondary-theme {
            @apply px-6 py-2.5 bg-transparent border-2 text-base font-medium rounded-lg shadow-sm transition-colors duration-200 ease-in-out;
            border-color: #ff7754; /* Theme border color */
            color: #ff7754; /* Theme text color */
        }
        .btn-secondary-theme:hover {
            background-color: #ff7754; /* Fill with theme color on hover */
            color: white; /* Make text white on hover */
        }

        /* --- End Custom Theme Colors --- */

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #e5e7eb; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .receipt-container {
            background-color: white;
            border-radius: 0px;
            border: 2px solid transparent;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            position: relative;
        }
        .receipt-container::before,
        .receipt-container::after {
            content: "";
            display: block;
            position: absolute;
            left: -1rem;
            right: -1rem;
            height: 16px;
        }

        .receipt-container::before {
            top: -8px;
            background:
                linear-gradient(-135deg, #f5f4f2 8px, transparent 0),
                linear-gradient(135deg, #f5f4f2 8px, transparent 0);
            background-size: 16px 16px;
        }

        .receipt-container::after {
            bottom: -8px;
            background:
                linear-gradient(-45deg, #f5f4f2 8px, transparent 0),
                linear-gradient(45deg, #f5f4f2 8px, transparent 0);
            background-size: 16px 16px;
        }
        .receipt-container.active {
            background-color: hsl(0, 0%, 100%);
            border-left: 2px solid #ff7754;
        }
        .btn-secondary {
            @apply px-5 py-2.5 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 transition ease-in-out duration-150;
        }
        .btn-danger {
            @apply px-5 py-2.5 bg-red-500 text-white rounded-lg hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-400 transition ease-in-out duration-150;
        }
        .tip-button {
            @apply px-2 py-1 text-lg font-receipt cursor-pointer transition-colors duration-200;
        }
        .tip-button.active {
            @apply text-theme font-bold;
        }
        .tip-button:not(.active) {
            @apply text-gray-600 hover:text-theme;
        }
    </style>
</head>
<body class="flex items-stretch justify-center min-h-screen pb-4 sm:p-6">

    <div class="w-full max-w-xl mx-auto bg-white rounded-none sm:rounded-2xl shadow-xl flex flex-col">
        <header class="bg-white text-gray-800 pt-0 sm:pt-4 p-4 rounded-t-2xl grid grid-cols-3 items-center">
            <div class="justify-self-start">
                <button id="header-back-button" class="hidden p-2 rounded-full hover:bg-gray-100 transition-colors" title="Back">
                    <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <button id="header-retake-button" class="hidden flex flex-col items-center space-y-1 p-2 rounded-md text-gray-700 hover:bg-gray-100 transition-colors">
                    <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    <span class="text-xs font-medium">Retake</span>
                </button>
            </div>

            <h1 id="app-title" class="text-3xl font-bold text-center font-title tracking-wider whitespace-nowrap">Bill Buddy</h1>

            <div class="justify-self-end flex items-center space-x-2">
                <button id="header-summary-button" class="hidden flex flex-col items-center space-y-1 p-2 rounded-md text-gray-700 hover:bg-gray-100 transition-colors">
                    <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                    <span class="text-xs font-medium">Summary</span>
                </button>
                <button id="header-finish-button" class="hidden p-2 rounded-full bg-[#72b167] hover:brightness-90 transition" title="Finish">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                </button>
            </div>
        </header>

        <main class="flex-grow p-4 sm:p-6 overflow-y-auto custom-scrollbar" style="background-color: #f5f4f2;">
            <div id="upload-view" class="font-comfortaa">
                <div class="bg-white p-6 sm:p-8 rounded-xl shadow-md">
                    <div class="flex items-center">
                        <span class="text-4xl mr-5">ðŸ“·</span>
                        <div>
                            <h3 class="font-semibold text-lg text-theme">Scan Receipt</h3>
                            <p class="text-gray-600 text-sm">Upload or snap a photo of your Bill.</p>
                        </div>
                    </div>

                    <div class="flex justify-start pl-4 my-2">
                        <span class="text-2xl text-theme">â†“</span>
                    </div>

                    <div class="flex items-center">
                        <span class="text-4xl mr-5">ðŸ§¾</span>
                        <div>
                            <h3 class="font-semibold text-lg text-theme">AI Wizardry</h3>
                            <p class="text-gray-600 text-sm">We'll read every line and turn it into an itemized digital receipt. No Confusion. No Fuss.</p>
                        </div>
                    </div>

                    <div class="flex justify-start pl-4 my-2">
                        <span class="text-2xl text-theme">â†“</span>
                    </div>

                    <div class="flex items-center">
                        <span class="text-4xl mr-5">ðŸ›’</span>
                        <div>
                            <h3 class="font-semibold text-lg text-theme">Split and Assign</h3>
                            <p class="text-gray-600 text-sm">Add items into you or your friends' cart to split the cost instantly. Done.</p>
                        </div>
                    </div>
                </div>

                <div class="mt-8">
                     <label for="receipt-upload" class="cursor-pointer flex flex-col items-center justify-center p-8 border-2 border-dashed rounded-xl bg-white transition-colors border-theme hover:bg-theme-light">
                        <svg class="h-12 w-12 text-theme" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <span class="mt-4 text-2xl font-semibold text-theme">Scan your Bill to Start</span>
                    </label>
                    <input id="receipt-upload" type="file" accept="image/*" class="hidden">
                </div>

                 <p id="userIdDisplay" class="text-center text-xs text-gray-400 mt-6 truncate">Connecting...</p>
            </div>


            <div id="processing-view" class="hidden text-center p-12 sm:p-16 font-comfortaa">
                <div class="loader mx-auto"></div>
                <p class="mt-6 text-gray-600 font-medium text-lg">Scanning Your Receipt...</p>
                <p class="mt-4 text-theme text-sm">We're Doing Some Serious AI Wizardry Here!</p>
            </div>

            <div id="results-view" class="hidden font-receipt">
                <div class="text-center mb-0"><h2 class="text-lg font-bold text-black" id="receipt-restaurant-name">Your Original Bill</h2></div>

               <div class="flex flex-col md:flex-row md:space-x-4 space-y-6 md:space-y-0">
                <div id="original-bill-container" class="w-full md:w-1/2 receipt-container p-4 flex flex-col">
                       <h3 id="original-bill-title" class="font-bold text-center text-2xl flex-shrink-0 text-black">Original Bill</h3>
                       <p id="original-bill-address" class="text-center text-xs text-gray-500"></p>
                       <p id="original-bill-datetime" class="text-center text-xs text-gray-500 mb-2 border-b pb-2"></p>
                       <div id="original-bill-list" class="space-y-2 text-base custom-scrollbar overflow-y-auto flex-grow"></div>
                       <div id="original-bill-totals" class="border-t pt-3 mt-auto flex-shrink-0"></div>
                   </div>

                   <div class="w-full md:w-1/2">
                       <div class="text-center mb-1"><h2 class="text-lg font-bold text-black">Your Individual Carts</h2></div>

                       <div id="splitters-section" class="space-y-4"></div>
                   </div>
               </div>

               <div id="add-splitter-form-container" class="mt-4 hidden">
                <form id="add-splitter-form" class="flex flex-col sm:flex-row items-center justify-center space-y-3 sm:space-y-0 sm:space-x-3">
                    <input type="text" id="splitter-name-input" placeholder="Add a friend's name..." class="font-comfortaa w-full sm:max-w-xs px-4 py-2 border border-gray-300 rounded-lg shadow-sm text-base focus:ring-indigo-500 focus:border-indigo-500" required>
                    <button type="submit" class="font-comfortaa w-full sm:w-auto px-6 py-2 border border-transparent text-base font-medium rounded-full shadow-sm text-white focus:outline-none focus:ring-2 focus:ring-offset-2 transition ease-in-out duration-150 bg-theme hover:bg-theme-dark focus:ring-theme">Add</button>
                </form>
            </div>

            </div>

            <div id="summary-view" class="hidden">
                <h2 class="text-lg font-bold text-center mb-1 text-gray-800 font-receipt">Summary of Carts</h2>
                <div id="summary-list" class="receipt-container px-4 pb-4 pt-2 shadow-lg font-receipt">
                    </div>
                <div class="mt-8 grid grid-cols-2 gap-4">
                    <button id="save-original-button" class="font-comfortaa w-full px-4 py-2.5 text-base font-medium rounded-lg shadow-sm text-white focus:outline-none focus:ring-2 focus:ring-offset-2 transition ease-in-out duration-150 bg-theme hover:bg-theme-dark focus:ring-theme border-2 border-theme flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 12v8a2 2 0 002 2h12a2 2 0 002-2v-8m-4-6l-4-4-4 4m4-4v12"></path></svg>
                        <span>Original Bill</span>
                    </button>
                    <button id="save-summary-button" class="font-comfortaa w-full px-4 py-2.5 text-base font-medium rounded-lg shadow-sm text-white focus:outline-none focus:ring-2 focus:ring-offset-2 transition ease-in-out duration-150 bg-theme hover:bg-theme-dark focus:ring-theme border-2 border-theme flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 12v8a2 2 0 002 2h12a2 2 0 002-2v-8m-4-6l-4-4-4 4m4-4v12"></path></svg>
                        <span>Summary Bill</span>
                    </button>
                </div>
               </div>

            <div id="error-view" class="hidden text-center p-12 sm:p-16 bg-red-50 rounded-xl shadow-sm">
                <p class="text-red-700 font-bold text-xl">Oops!</p>
                <p id="error-message" class="text-red-600 mt-3 text-base"></p>
                <button id="try-again-button" class="mt-8 btn-danger">Try Again</button>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, deleteDoc, setLogLevel, getDocs, doc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DOM ELEMENT REFERENCES ---
        const uploadView = document.getElementById('upload-view'), processingView = document.getElementById('processing-view'), resultsView = document.getElementById('results-view'), errorView = document.getElementById('error-view'), summaryView = document.getElementById('summary-view');
        const errorMessage = document.getElementById('error-message'), receiptUploadInput = document.getElementById('receipt-upload');
        const originalBillList = document.getElementById('original-bill-list'), originalBillTotals = document.getElementById('original-bill-totals'), originalBillTitle = document.getElementById('original-bill-title'), originalBillAddress = document.getElementById('original-bill-address'), originalBillDateTime = document.getElementById('original-bill-datetime');
        const splittersSection = document.getElementById('splitters-section');
        const addSplitterFormContainer = document.getElementById('add-splitter-form-container'), addSplitterForm = document.getElementById('add-splitter-form'), splitterNameInput = document.getElementById('splitter-name-input');
        const userIdDisplay = document.getElementById('userIdDisplay'), appTitle = document.getElementById('app-title'), receiptRestaurantName = document.getElementById('receipt-restaurant-name');
        const tryAgainButton = document.getElementById('try-again-button');
        const summaryList = document.getElementById('summary-list');
        const headerBackButton = document.getElementById('header-back-button'), headerFinishButton = document.getElementById('header-finish-button'), headerRetakeButton = document.getElementById('header-retake-button'), headerSummaryButton = document.getElementById('header-summary-button');

        // --- APP STATE ---
        let db, auth, userId, unsubClaimed = null, unsubSplitters = null, activeSplitterName = null;
        let scannedReceipt = { restaurantName: '', restaurantAddress: '', currency: '$', subtotal: 0, tax: 0, taxIncluded: false, items: [], date: '', time: '' };
        let allClaimedItems = [], allSplitters = [];
        let taxPercentage = 0; // Default tax percentage
        let tipPercentage = 10; // Default tip percentage
        let isCustomTipActive = false;

        function showView(viewName, message = '') {
            [uploadView, processingView, resultsView, errorView, summaryView].forEach(v => v.classList.add('hidden'));
            document.getElementById(`${viewName}-view`).classList.remove('hidden');
            if (viewName === 'error') errorMessage.textContent = message || "An unknown error occurred.";

            // Show/Hide header buttons based on the current view
            if (viewName === 'summary') {
                headerBackButton.classList.remove('hidden');
                headerFinishButton.classList.remove('hidden');
                headerRetakeButton.classList.add('hidden');
                headerSummaryButton.classList.add('hidden');
            } else if (viewName === 'results') {
                headerRetakeButton.classList.remove('hidden');
                headerSummaryButton.classList.remove('hidden');
                headerBackButton.classList.add('hidden');
                headerFinishButton.classList.add('hidden');
            } else {
                headerBackButton.classList.add('hidden');
                headerFinishButton.classList.add('hidden');
                headerRetakeButton.classList.add('hidden');
                headerSummaryButton.classList.add('hidden');
            }
        }

        function toBase64(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => resolve(reader.result.split(',')[1]); reader.onerror = reject; }); }

        async function processReceiptImage(base64ImageData) {
            showView('processing');
            const apiKey = "AIzaSyCFmm2VVu_uKLBCIjSdqA-xcvjAaWjq6DQ"; // YOUR GEMINI API KEY
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{
                    parts: [
                        // --- 1. IMPROVED PROMPT ---
                        { text: "Analyze this receipt. Extract the restaurant's name, its address, date, time, the currency symbol, the subtotal, any tax amount, and a list of items. For each item, provide its name, quantity, and the **per-unit price**. It is very important that you return the price for a single unit. If a per-unit price is not listed, you must calculate it by dividing the total line price by the quantity. **If a currency symbol is not written on the receipt, infer the correct currency symbol from the restaurant's location (e.g., a receipt from Cape Town uses 'R').** Crucially, determine if the tax is already included in the individual item prices and provide a boolean `taxIncludedInPrice` flag for this. Provide response as a JSON object." },
                        { inlineData: { mimeType: "image/jpeg", data: base64ImageData } }
                    ]
                }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            restaurantName: { type: "STRING" },
                            restaurantAddress: { type: "STRING" },
                            date: { type: "STRING" },
                            time: { type: "STRING" },
                            currency: { type: "STRING" },
                            subtotal: { type: "NUMBER" },
                            tax: { type: "NUMBER" },
                            taxIncludedInPrice: { type: "BOOLEAN" },
                            items: {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        name: { type: "STRING" },
                                        price: { type: "NUMBER" },
                                        quantity: { type: "NUMBER" }
                                    },
                                    required: ["name", "price", "quantity"]
                                }
                            }
                        },
                        required: ["restaurantName", "items", "taxIncludedInPrice"]
                    }
                }
            };

            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
                const result = await response.json();

                if (result.candidates?.[0].content?.parts?.[0]) {
                    const parsedJson = JSON.parse(result.candidates[0].content.parts[0].text);
                    if (parsedJson.items?.length > 0) {

                        const taxIncluded = parsedJson.taxIncludedInPrice || false;
                        let currencyString = parsedJson.currency;
                        const isValidSymbol = symbol => symbol && symbol.length < 5 && symbol.toLowerCase() !== 'unknown';

                        if (!isValidSymbol(currencyString)) {
                            if (parsedJson.restaurantAddress) {
                                currencyString = await getCurrencyFromAddress(parsedJson.restaurantAddress);
                            } else {
                                currencyString = null;
                            }
                        }

                        const finalCurrencySymbol = normalizeCurrencySymbol(currencyString);
                        const subtotal = parsedJson.subtotal || parsedJson.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                        const tax = parsedJson.tax || 0;

                        if (taxIncluded) {
                            taxPercentage = 0;
                        } else if (subtotal > 0 && tax > 0) {
                            taxPercentage = (tax / subtotal) * 100;
                        } else {
                            taxPercentage = 0;
                        }

                        scannedReceipt = {
                            restaurantName: parsedJson.restaurantName,
                            restaurantAddress: parsedJson.restaurantAddress || '',
                            date: parsedJson.date || '',
                            time: parsedJson.time || '',
                            // --- 2. SAFER FALLBACK ---
                            currency: finalCurrencySymbol || '', // Default to an empty string instead of '$'
                            subtotal: subtotal,
                            tax: tax,
                            taxIncluded: taxIncluded,
                            items: parsedJson.items.map((item, index) => ({ ...item, id: `item-${index}` }))
                        };

                        originalBillTitle.textContent = scannedReceipt.restaurantName || "Original Bill";
                        originalBillAddress.textContent = scannedReceipt.restaurantAddress;
                        originalBillDateTime.textContent = `${formatDate(scannedReceipt.date)} ${scannedReceipt.time}`.trim();

                        await clearAllData();
                        addSplitterFormContainer.classList.remove('hidden');
                        renderApp();
                        showView('results');
                    } else throw new Error("AI could not find items on the receipt.");
                } else throw new Error("The AI returned an unexpected response.");
            } catch (error) { showView('error', error.message); }
        }

        function setupDynamicInputs() {
            // Setup tax input
            const taxInput = document.getElementById('tax-percentage-input');
            if (taxInput) {
                taxInput.addEventListener('input', () => {
                    const value = parseFloat(taxInput.value);
                    taxPercentage = isNaN(value) ? 0 : value;
                    renderApp();
                });
            }

            // Setup tip buttons
            document.querySelectorAll('.tip-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    isCustomTipActive = false;
                    tipPercentage = parseInt(e.target.dataset.percent);
                    renderApp();
                });
            });

            // Setup custom tip (if exists)
            const customInput = document.getElementById('custom-tip-input');
             if (customInput) {
                 customInput.focus();
                 customInput.select();
                 customInput.addEventListener('input', () => {
                     const value = parseFloat(customInput.value);
                     tipPercentage = isNaN(value) ? 0 : value;
                     renderApp();
                 });
             }
        }


        const countryToCurrencyMap = {
            'ZA': 'R', 'GB': 'Â£', 'US': '$', 'CA': '$', 'AU': '$',
            'JP': 'Â¥', 'CN': 'Â¥', 'IN': 'â‚¹', 'DE': 'â‚¬', 'FR': 'â‚¬',
            'ES': 'â‚¬', 'IT': 'â‚¬', 'NL': 'â‚¬', 'IE': 'â‚¬',
        };

        const currencyCodeToSymbolMap = {
            'EUR': 'â‚¬', 'USD': '$', 'CAD': '$', 'AUD': '$', 'GBP': 'Â£',
            'JPY': 'Â¥', 'CNY': 'Â¥', 'INR': 'â‚¹', 'ZAR': 'R'
        };

        function normalizeCurrencySymbol(currencyString) {
            if (!currencyString) return null;
            const upperCaseCurrency = currencyString.toUpperCase();
            if (currencyCodeToSymbolMap[upperCaseCurrency]) {
                return currencyCodeToSymbolMap[upperCaseCurrency];
            }
            return currencyString;
        }

        async function getCurrencyFromAddress(address) {
            if (!address) return null;
            const encodedAddress = encodeURIComponent(address);
            const apiUrl = `https://nominatim.openstreetmap.org/search?q=${encodedAddress}&format=json&limit=1&addressdetails=1`;
            try {
                const response = await fetch(apiUrl, { headers: { 'Accept': 'application/json' }});
                if (!response.ok) return null;
                const data = await response.json();
                if (data && data.length > 0) {
                    const countryCode = data[0].address.country_code.toUpperCase();
                    return countryToCurrencyMap[countryCode] || null;
                }
                return null;
            } catch (error) {
                console.error("Geocoding API failed:", error);
                return null;
            }
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            if (isNaN(date.getTime())) {
                return dateString;
            }
            const options = { day: 'numeric', month: 'long', year: 'numeric' };
            return date.toLocaleDateString('en-GB', options);
        }

        function renderApp() {
            appTitle.textContent = 'Bill Buddy';

            const claimedByOriginalId = allClaimedItems.reduce((acc, item) => {
                const id = item.data.originalId;
                if (!acc[id]) acc[id] = 0;
                acc[id]++;
                return acc;
            }, {});

            originalBillList.innerHTML = '';
            scannedReceipt.items.forEach(originalItem => {
                const takenCount = claimedByOriginalId[originalItem.id] || 0;
                const remainingCount = originalItem.quantity - takenCount;
                const isClaimed = remainingCount <= 0;

                const itemEl = document.createElement('div');
                itemEl.className = `flex items-center justify-between py-0 ${isClaimed ? 'text-gray-400 line-through' : ''}`;
                itemEl.innerHTML = `<div class="flex-grow pr-1"><span class="bg-gray-200 text-gray-700 font-bold px-2 py-1 rounded-md text-sm">${remainingCount}x</span><span class="ml-3">${originalItem.name}</span></div><div class="flex-shrink-0 w-20 text-right"><span>${scannedReceipt.currency}${originalItem.price.toFixed(2)}</span></div><div class="flex-shrink-0 w-10 text-right"><button class="add-to-bill-btn text-green-500 hover:text-green-700 transition ease-in-out duration-150 ${isClaimed || !activeSplitterName ? 'opacity-30 cursor-not-allowed' : ''}" ${isClaimed || !activeSplitterName ? 'disabled' : ''}><svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></button></div>`;
                if (!isClaimed && activeSplitterName) { itemEl.querySelector('.add-to-bill-btn').onclick = () => addItemToBill({ name: originalItem.name, price: originalItem.price, originalId: originalItem.id }); }
                originalBillList.appendChild(itemEl);
            });

            const claimedBySplitter = allClaimedItems.reduce((acc, item) => {
                const name = item.data.splitterName;
                if (!acc[name]) acc[name] = [];
                acc[name].push(item);
                return acc;
            }, {});

            let totalAmountInCarts = 0;

            splittersSection.innerHTML = '';
            allSplitters.forEach(splitter => {
                const name = splitter.data.name;
                const items = claimedBySplitter[name] || [];
                const itemsTotal = items.reduce((sum, item) => sum + item.data.price, 0);
                const taxForPerson = itemsTotal * (taxPercentage / 100);
                const tipForPerson = itemsTotal * (tipPercentage / 100);
                const totalWithTaxAndTip = itemsTotal + taxForPerson + tipForPerson;
                const isActive = name === activeSplitterName;

                totalAmountInCarts += totalWithTaxAndTip;

                const splitterEl = document.createElement('div');
                splitterEl.className = `receipt-container p-4 cursor-pointer ${isActive ? 'active' : ''}`;

                let bodyHtml = '';
                if (isActive) {
                    if (items.length === 0) {
                        bodyHtml = `<p class="text-gray-400 text-center p-3 text-sm">Claim items from the Original Bill.</p>`;
                    } else {
                        const groupedItems = items.reduce((acc, item) => {
                             const key = item.data.originalId;
                             if (!acc[key]) acc[key] = { ...item.data, count: 0, docIds: [] };
                             acc[key].count++;
                             acc[key].docIds.push(item.id);
                             return acc;
                        }, {});

                        Object.values(groupedItems).forEach(item => {
                            bodyHtml += `<div class="flex items-center justify-between py-0"><div class="flex-grow pr-1"><span class="bg-gray-200 text-gray-800 font-bold px-2 py-1 rounded-md text-sm">${item.count}x</span><span class="ml-3">${item.name}</span></div><div class="flex-shrink-0 w-10 text-right"><button class="remove-from-bill-btn text-red-500 hover:text-red-700 transition ease-in-out duration-150" data-docid="${item.docIds[item.docIds.length - 1]}"><svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></button></div></div>`;
                        });

                        const totalsHtml = `
                            <div class="border-t border-dashed mt-3 pt-3">
                                <div class="flex justify-between items-center text-base mb-1">
                                    <span class="text-gray-500 font-medium">Your Subtotal</span>
                                    <span class="text-gray-700 font-medium">${scannedReceipt.currency}${itemsTotal.toFixed(2)}</span>
                                </div>
                                <div class="flex justify-between items-center text-base mb-1">
                                    <span class="text-gray-500 font-medium">Tax</span>
                                    <span class="text-gray-700 font-medium">+ ${scannedReceipt.currency}${taxForPerson.toFixed(2)}</span>
                                </div>
                                <div class="flex justify-between items-center text-base">
                                     <span class="text-gray-500 font-medium">Tip</span>
                                     <span class="text-gray-700 font-medium">+ ${scannedReceipt.currency}${tipForPerson.toFixed(2)}</span>
                                </div>
                            </div>
                        `;
                        bodyHtml += totalsHtml;
                    }
                }

                splitterEl.innerHTML = `<div class="flex justify-between items-center font-bold text-lg"><span class="${isActive ? 'text-theme' : 'text-gray-800'}">${name}</span><span>${scannedReceipt.currency}${totalWithTaxAndTip.toFixed(2)}</span></div><div class="splitter-body mt-3 space-y-0 text-base ${isActive ? '' : 'hidden'}">${bodyHtml}</div>`;

                splitterEl.onclick = (e) => {
                    if (e.target.closest('.remove-from-bill-btn')) {
                       const docId = e.target.closest('.remove-from-bill-btn').dataset.docid;
                       removeItemFromBill(docId);
                       return;
                    }
                    activeSplitterName = name;
                    renderApp();
                };
                splittersSection.appendChild(splitterEl);
            });

            const subtotal = scannedReceipt.subtotal;
            const taxAmount = subtotal * (taxPercentage / 100);
            const tipAmount = subtotal * (tipPercentage / 100);
            const grandTotal = subtotal + taxAmount + tipAmount;
            const balance = grandTotal - totalAmountInCarts;
            const balanceColorClass = balance > 0.001 ? 'text-red-600' : 'text-green-600';

            const tipButtonBaseClasses = 'tip-button px-3 py-1 rounded-lg text-lg font-receipt cursor-pointer transition-all duration-200';
            const tipButtonActiveClasses = 'bg-theme text-white font-bold shadow';
            const tipButtonInactiveClasses = 'text-gray-600 bg-gray-100 hover:bg-theme-light hover:text-theme';

            originalBillTotals.innerHTML = `
                <div class="flex justify-between font-medium text-gray-600 mb-2 text-lg">
                    <span>Subtotal:</span>
                    <span>${scannedReceipt.currency}${subtotal.toFixed(2)}</span>
                </div>

                ${scannedReceipt.taxIncluded
                    ? `<div class="flex justify-between items-center text-lg mb-2">
                           <span class="font-medium text-gray-600">Tax:</span>
                           <span class="font-receipt text-gray-800 bg-gray-100 rounded px-2 py-1 text-base">Already Included</span>
                       </div>`
                    : `<div class="flex justify-between items-center text-lg mb-2 text-gray-600">
                           <span class="font-medium">Tax (${taxPercentage > 0 ? taxPercentage.toFixed(2) : '0.00'}%):</span>
                           <span class="font-receipt text-gray-500 font-medium">+ ${scannedReceipt.currency}${taxAmount.toFixed(2)}</span>
                       </div>`
                }
                <div class="flex justify-between items-center text-lg mb-3">
                    <span class="font-medium text-gray-600">Tip:</span>
                    <div class="flex items-center space-x-2">
                        <button class="${tipButtonBaseClasses} ${tipPercentage === 0 ? tipButtonActiveClasses : tipButtonInactiveClasses}" data-percent="0">0%</button>
                        <button class="${tipButtonBaseClasses} ${tipPercentage === 10 ? tipButtonActiveClasses : tipButtonInactiveClasses}" data-percent="10">10%</button>
                        <button class="${tipButtonBaseClasses} ${tipPercentage === 15 ? tipButtonActiveClasses : tipButtonInactiveClasses}" data-percent="15">15%</button>
                        <button class="${tipButtonBaseClasses} ${tipPercentage === 20 ? tipButtonActiveClasses : tipButtonInactiveClasses}" data-percent="20">20%</button>
                    </div>
                </div>

                <div class="text-right font-receipt text-lg text-gray-500">
                    
                    <span>${scannedReceipt.currency}${tipAmount.toFixed(2)}</span>
                </div>

                <div class="flex justify-between font-bold text-lg border-t-2 pt-2 mt-2">
                    <span>Total:</span>
                    <span>${scannedReceipt.currency}${grandTotal.toFixed(2)}</span>
                </div>
                <div class="flex justify-between ${balanceColorClass} font-bold mt-1 text-lg">
                    <span>Balance Due:</span>
                    <span>${scannedReceipt.currency}${balance.toFixed(2)}</span>
                </div>
                `;
            setupDynamicInputs();
        }

        function renderSummaryView() {
            summaryList.innerHTML = '';

            const claimedBySplitter = allClaimedItems.reduce((acc, item) => {
                const name = item.data.splitterName;
                if (!acc[name]) acc[name] = [];
                acc[name].push(item);
                return acc;
            }, {});

            let grandTotalOfItems = 0;
            let grandTotalOfTaxes = 0;
            let grandTotalOfTips = 0;

            let combinedHtml = `
            <div class="text-right text-xs text-theme pb-0 mb-2">Powered By Bill Buddy</div>
                <div class="text-center mb-0">
                    <h2 class="text-lg font-bold text-black" id="summary-restaurant-name">${scannedReceipt.restaurantName || "Summary Bill"}</h2>
                    <p class="text-center text-xs text-gray-500" id="summary-restaurant-address">${scannedReceipt.restaurantAddress}</p>
                    ${(scannedReceipt.date || scannedReceipt.time) ? `<p class="text-center text-xs text-gray-500 mb-2">${formatDate(scannedReceipt.date)} ${scannedReceipt.time}</p>` : ''}
                </div>
            `;

            let peopleCountInSummary = 0;
            allSplitters.forEach((splitter) => {
                const name = splitter.data.name;
                const items = claimedBySplitter[name] || [];
                if (items.length === 0) return;

                if (peopleCountInSummary > 0) {
                    combinedHtml += `<div class="border-t-2 border-dashed border-gray-200 my-4"></div>`;
                }

                const itemsSubTotal = items.reduce((sum, item) => sum + item.data.price, 0);
                const taxForPerson = itemsSubTotal * (taxPercentage / 100);
                const tipForPerson = itemsSubTotal * (tipPercentage / 100);
                const totalForSplitter = itemsSubTotal + taxForPerson + tipForPerson;

                grandTotalOfItems += itemsSubTotal;
                grandTotalOfTaxes += taxForPerson;
                grandTotalOfTips += tipForPerson;

                let itemsHtml = '';
                const groupedItems = items.reduce((acc, item) => {
                     const key = item.data.name;
                     if (!acc[key]) acc[key] = { ...item.data, count: 0, totalPrice: 0 };
                     acc[key].count++;
                     acc[key].totalPrice += item.data.price;
                     return acc;
                }, {});

                Object.values(groupedItems).forEach(item => {
                    itemsHtml += `<div class="flex justify-between items-center text-sm text-black py-0">
                                    <span>${item.count}x ${item.name}</span>
                                    <span>${scannedReceipt.currency}${item.totalPrice.toFixed(2)}</span>
                                  </div>`;
                });

                itemsHtml += `<div class="flex justify-between items-center text-sm text-gray-600 py-1 mt-2 border-t pt-2"><span class="font-bold">Subtotal</span><span class="font-bold">${scannedReceipt.currency}${itemsSubTotal.toFixed(2)}</span></div>`;
                itemsHtml += `<div class="flex justify-between items-center text-sm text-gray-600 py-0"><span class="font-bold">Tax</span><span class="font-bold">+ ${scannedReceipt.currency}${taxForPerson.toFixed(2)}</span></div>`;
                itemsHtml += `<div class="flex justify-between items-center text-sm text-gray-600 py-0"><span class="font-bold">Tip</span><span class="font-bold">+ ${scannedReceipt.currency}${tipForPerson.toFixed(2)}</span></div>`;

                combinedHtml += `
                    <h3 class="font-bold text-lg text-theme">${name}</h3>
                    <div class="mt-2 mb-3">${itemsHtml}</div>
                    <div class="text-right font-bold text-black pt-2 border-t mt-2">Total: ${scannedReceipt.currency}${totalForSplitter.toFixed(2)}</div>
                `;

                peopleCountInSummary++;
            });

            const finalGrandTotal = grandTotalOfItems + grandTotalOfTaxes + grandTotalOfTips;

            combinedHtml += `
                <div class="mt-8 pt-2 text-right font-bold text-xl text-gray-800">
                    <span>Grand Total: ${scannedReceipt.currency}${finalGrandTotal.toFixed(2)}</span>
                </div>
                `;
            summaryList.innerHTML = combinedHtml;
        }


        async function saveElementAsImage(elementId, fileName, buttonElement) {
            const originalText = buttonElement.innerHTML;
            buttonElement.innerHTML = 'Saving...';
            buttonElement.disabled = true;

            const captureArea = document.getElementById(elementId);
            if (!captureArea) {
                console.error(`Element with ID "${elementId}" not found.`);
                alert('Error: Could not find the content to save.');
                buttonElement.innerHTML = originalText;
                buttonElement.disabled = false;
                return;
            }

            const frame = document.createElement('div');
            frame.style.padding = '25px';
            frame.style.backgroundColor = '#f5f4f2';
            frame.style.width = captureArea.offsetWidth + 'px';
            frame.style.position = 'absolute';
            frame.style.top = '-9999px';
            frame.style.left = '-9999px';

            const clonedCaptureArea = captureArea.cloneNode(true);

            try {
                frame.appendChild(clonedCaptureArea);
                document.body.appendChild(frame);

                const canvas = await html2canvas(frame, {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: null
                });

                if (navigator.share && navigator.canShare) {
                    canvas.toBlob(async (blob) => {
                        const file = new File([blob], fileName, { type: blob.type });
                        const shareData = {
                            files: [file],
                            title: fileName.split('.')[0].replace(/-/g, ' '),
                            text: 'Your Digital Receipt from Bill Buddy.',
                        };
                        if (navigator.canShare(shareData)) {
                            try {
                                await navigator.share(shareData);
                            } catch (err) {
                                if (err.name !== 'AbortError') {
                                    console.error('Share API error:', err);
                                    triggerDownload(canvas, fileName);
                                }
                            }
                        } else {
                            triggerDownload(canvas, fileName);
                        }
                    }, 'image/png');
                } else {
                    triggerDownload(canvas, fileName);
                }

            } catch (error) {
                console.error("Oops, something went wrong!", error);
                alert("Error: Could not save image.");
            } finally {
                document.body.removeChild(frame);
                buttonElement.innerHTML = originalText;
                buttonElement.disabled = false;
            }
        }

        async function clearAllData() {
            if (!userId || !db) return;
            const batch = writeBatch(db);
            const claimedRef = collection(db, 'claimed_items');
            const splittersRef = collection(db, 'splitters');

            const claimedSnapshot = await getDocs(claimedRef);
            claimedSnapshot.forEach(doc => batch.delete(doc.ref));

            const splittersSnapshot = await getDocs(splittersRef);
            splittersSnapshot.forEach(doc => batch.delete(doc.ref));

            await batch.commit();
        }

        async function resetApp() {
            await clearAllData();

            scannedReceipt = { restaurantName: '', restaurantAddress: '', currency: '$', subtotal: 0, tax: 0, taxIncluded: false, items: [], date: '', time: '' };
            activeSplitterName = null;
            allClaimedItems = [];
            allSplitters = [];
            taxPercentage = 0;
            tipPercentage = 10;

            appTitle.textContent = 'Bill Buddy';
            originalBillTitle.textContent = 'Original Bill';
            originalBillAddress.textContent = '';
            splitterNameInput.value = '';
            addSplitterFormContainer.classList.add('hidden');

            showView('upload');
        }

        async function addSplitter(name) {
             if (!userId || !db) return;
             try {
                const collectionRef = collection(db, 'splitters');
                await addDoc(collectionRef, { name, createdAt: new Date() });
             } catch (error) { console.error("Error adding splitter:", error); }
        }

        async function addItemToBill(item) {
            if (!userId || !db || !activeSplitterName) return;
            try {
                const collectionRef = collection(db, 'claimed_items');
                await addDoc(collectionRef, { ...item, splitterName: activeSplitterName, createdAt: new Date() });
            } catch (error) { console.error("Error adding item:", error); }
        }

        async function removeItemFromBill(docId) {
            if (!userId || !db) return;
            try {
                const docRef = doc(db, 'claimed_items', docId);
                await deleteDoc(docRef);
            } catch (error) { console.error("Error removing item:", error); }
        }

        function setupListeners() {
            if (unsubClaimed) unsubClaimed();
            if (unsubSplitters) unsubSplitters();

            const claimedRef = collection(db, 'claimed_items');
            unsubClaimed = onSnapshot(claimedRef, (snapshot) => {
                allClaimedItems = snapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));
                if (scannedReceipt.items.length > 0) renderApp();
            });

            const splittersRef = collection(db, 'splitters');
            unsubSplitters = onSnapshot(splittersRef, (snapshot) => {
                allSplitters = snapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));
                if (scannedReceipt.items.length > 0) renderApp();
            });
        }

        function triggerDownload(canvas, fileName) {
            const link = document.createElement('a');
            link.download = fileName;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }

        // --- EVENT LISTENERS ---
        receiptUploadInput.addEventListener('change', async (event) => { if (event.target.files[0]) { const base64Data = await toBase64(event.target.files[0]); processReceiptImage(base64Data); } });
        tryAgainButton.addEventListener('click', () => showView('upload'));
        addSplitterForm.addEventListener('submit', (e) => { e.preventDefault(); const name = splitterNameInput.value.trim(); if (name && !allSplitters.find(s => s.data.name === name)) { activeSplitterName = name; addSplitter(name); splitterNameInput.value = ''; } });

        headerBackButton.addEventListener('click', () => {
            showView('results');
        });

        appTitle.addEventListener('click', resetApp);
        headerRetakeButton.addEventListener('click', resetApp);
        headerFinishButton.addEventListener('click', resetApp);
        headerSummaryButton.addEventListener('click', () => {
            renderSummaryView();
            showView('summary');
        });

        document.getElementById('save-summary-button').addEventListener('click', function() {
            saveElementAsImage('summary-list', 'bill-buddy-summary.png', this);
        });
        document.getElementById('save-original-button').addEventListener('click', function() {
            saveElementAsImage('original-bill-container', 'bill-buddy-original.png', this);
        });

        // --- INITIALIZATION ---
        async function initialize() {
            const firebaseConfig = {
                apiKey: "AIzaSyAELza0EhhCP1qKKqhMTOMr-ZAQRun7iXM",
                authDomain: "bill-splitter-v1.firebaseapp.com",
                projectId: "bill-splitter-v1",
                storageBucket: "bill-splitter-v1.appspot.com",
                messagingSenderId: "752281135823",
                appId: "1:752281135823:web:0a283053ce8b9fc519e5ba",
                measurementId: "G-6VZGWPHFM4"
            };

            try {
                setLogLevel('error');
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = `User ID: ${userId.substring(0,8)}...`;
                        if (!unsubClaimed) { clearAllData(); }
                        setupListeners();
                        showView('upload');
                    }
                });

                if (!auth.currentUser) {
                    await signInAnonymously(auth);
                }

            } catch (error) {
                showView('error', `Initialization failed: ${error.message}`);
            }
        }

        initialize();

    </script>
</body>
</html>